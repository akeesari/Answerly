import faiss
import numpy as np

_index = None
_embeddings = []
_text_chunks = []

def initialize_index(dims=384):
    global _index
    _index = faiss.IndexFlatL2(dims)

def add_chunks(chunks, embeddings):
    global _index, _text_chunks, _embeddings
    if _index is None:
        initialize_index()
    _text_chunks.extend(chunks)
    _embeddings.extend(embeddings)
    np_embeddings = np.array(embeddings).astype('float32')
    _index.add(np_embeddings)

def search_similar_chunks(query_embedding, top_k=3):
    if _index is None or len(_text_chunks) == 0:
        return []
    np_query = np.array([query_embedding]).astype('float32')
    distances, indices = _index.search(np_query, top_k)
    results = []
    for idx in indices[0]:
        if idx < len(_text_chunks):
            results.append(_text_chunks[idx])
    return results
